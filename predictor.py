import numpy as np
from math import sqrt, ceil
import cv2
from keras.preprocessing.image import ImageDataGenerator
import keras


def malware_detector(file_name):
    # convert malware to image
    input_file_name = file_name
    with open(input_file_name, 'rb') as binary_file:        
        data = binary_file.read()
    data_len = len(data)
    d = np.frombuffer(data, dtype=np.uint8)
    sqrt_len = int(ceil(sqrt(data_len)))
    new_len = sqrt_len*sqrt_len
    pad_len = new_len - data_len
    padded_d = np.hstack((d, np.zeros(pad_len, np.uint8)))
    im = np.reshape(padded_d, (sqrt_len, sqrt_len))
    cv2.imwrite('detection_test_2/file/malware.png', im)

    # Generate Image Data
    batch_3 = ImageDataGenerator().flow_from_directory(directory='detection_test_2', target_size=(64,64), batch_size=10000)
    image_2, label = next(batch_3)

    # load model
    Malware_detector = keras.models.load_model('models/malware_detector_2.h5')

    # Predict malware type
    y_pred_new = Malware_detector.predict(image_2, verbose=0)

    # Convert it into understandable data
    position = np.where(max(y_pred_new))
    new_arr = []
    for i in position[0]:
        new_arr.append(y_pred_new[0][i])
    position_m = np.where(y_pred_new == max(new_arr))
    position_1 = position_m[1][0]
    
    dictionary = {"0": "Adialer.C", "1": "Agent.FYI", "2": "Allaple.A", "3": "Allaple.L", "4": "Alueron.gen!J", "5": "Autorun.K", "6": "C2LOP.P", "7": "C2LOP.gen!g", "8": "Dialplatform.B", "9": "Dontovo.A", "10": "Fakerean", "11": "Instantaccess", "12": "Lolyda.AA1", "13": "Lolyda.AA2", "14": "Lolyda.AA3", "15": "Lolyda.AT", "16": "Malex.gen!J", "17": "Obfuscator.AD", "18": "Rbot!gen", "19": "Skintrim.N", "20": "Swizzor.gen!E", "21": "Swizzor.gen!I", "22": "VB.AT", "23": "Wintrim.BX", "24": "Yuner.A", "25": "No Malware"}
    type_detail = dictionary[str(position_1)]
    type_malware = {'Dialer': ['Adialer.C', 'Dialplatform.B', 'Instantaccess'],
                    'Backdoor': ['Agent.FYI', 'Rbot!gen'],
                    'Worm': ['Allaple.A', 'Allaple.L', 'Alueron.gen!J', 'Autorun.k', 'AutoIT', 'VB.AT', 'Yuner.A'],
                    'Trojan': ['C2LOP.P', 'C2LOP.gen!g', 'Malex.gen!J', 'Skintrim.N'],
                    'Trojan Downloader': ['Dontovo.A', 'Obfuscator.AD', 'Swizzor.gen!E', 'Swizzor.gen!I', 'Wintrim.BX'],
                    'PWS': ['Lolyda.AA1', 'Lolyda.AA2', 'Lolyda.AA3', 'Lolyda.AT'],
                    'No Malware': ['No Malware']
                    }

    for i in type_malware:
        if type_detail in type_malware[i]:
            print(i)
            break

malware_detector('3eff13340e0b34b34a87485ef702924b8b80fa506f120c297c8474c3afcc2c85')